<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Web Audio 1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <style>
    body { 
      font-family: sans-serif; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 2rem; 
      background-color: #f5f5f5;
    }
    
    .control-buttons {
      display: flex;
      margin: 1rem 0;
    }
    
    .control-btn {
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      margin: 0 0.5rem;
      padding: 0.8rem 1.5rem;
      font-size: 1.1rem;
      transition: background-color 0.3s;
    }
    
    .control-btn:hover {
      background-color: #0b7dda;
    }
    
    .stop-btn {
      background-color: #f44336;
    }
    
    .stop-btn:hover {
      background-color: #d32f2f;
    }
    
    .sequence-display {
      border: 1px solid #ccc;
      padding: 1rem;
      min-height: 50px;
      width: 90%;
      max-width: 800px;
      margin: 1rem 0;
      border-radius: 4px;
      text-align: center;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .note-pill {
      display: inline-block;
      background-color: #4CAF50;
      color: white;
      padding: 0.3rem 0.6rem;
      margin: 0.2rem;
      border-radius: 15px;
      font-size: 0.9rem;
    }
    
    /* Piano Keyboard Styling */
    .piano-container {
      position: relative;
      width: 90%;
      max-width: 900px;
      height: 200px;
      margin: 20px auto;
      overflow-x: auto;
      background-color: #222;
      padding: 18px 18px 28px 18px;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.18);
    }
    
    .piano {
      display: flex;
      height: 170px;
      position: relative;
      margin: 0 auto;
      z-index: 1;
    }
    
    .white-key {
      background: linear-gradient(180deg, #fff 80%, #e0e0e0 100%);
      border: 1.5px solid #bbb;
      width: 38px;
      height: 170px;
      position: relative;
      margin: 0 -2px;
      border-radius: 0 0 6px 6px;
      cursor: pointer;
      z-index: 1;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: background 0.1s, box-shadow 0.1s;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    
    .white-key:hover, .white-key.active {
      background: linear-gradient(180deg, #f8f8f8 60%, #d1eaff 100%);
      box-shadow: 0 4px 16px rgba(33,150,243,0.12);
      border-color: #2196F3;
    }
    
    .black-key {
      background: linear-gradient(180deg, #222 60%, #444 100%);
      width: 22px;
      height: 110px;
      position: absolute;
      margin-left: -11px;
      z-index: 2;
      cursor: pointer;
      border-radius: 0 0 4px 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      border: 1.5px solid #111;
      transition: background 0.1s, box-shadow 0.1s;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    
    .black-key:hover, .black-key.active {
      background: linear-gradient(180deg, #444 40%, #2196F3 100%);
      box-shadow: 0 4px 16px rgba(33,150,243,0.18);
      border-color: #2196F3;
    }
    
    .key-label {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #888;
      pointer-events: none;
      font-family: monospace;
      background: rgba(255,255,255,0.7);
      padding: 1px 4px;
      border-radius: 6px;
    }
    
    .black-key .key-label {
      color: #fff;
      background: rgba(0,0,0,0.7);
      bottom: 12px;
      font-size: 9px;
    }
    
    .octave-label {
      position: absolute;
      bottom: -22px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 13px;
      color: #fff;
      font-family: monospace;
      background: rgba(33,33,33,0.7);
      padding: 2px 10px;
      border-radius: 8px;
      z-index: 3;
      pointer-events: none;
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¹ Interactive Piano Sequencer</h1>
  
  <div class="piano-container">
    <div class="piano" id="piano-keyboard">
      <!-- Piano keys will be generated by JavaScript -->
    </div>
  </div>
  
  <div class="sequence-display" id="sequence-display">
    <p id="empty-message">Click piano keys to add notes to the sequence</p>
  </div>
  
  <div class="control-buttons">
    <button class="control-btn" onclick="Tone.start().then(startSequence)">Play Sequence</button>
    <button class="control-btn stop-btn" onclick="stopSequence()">Stop</button>
    <button class="control-btn" onclick="clearSequence()">Clear</button>
  </div>

  <script>
    const synth = new Tone.Synth().toDestination();
    let noteSequence = [];
    let sequencePlayer = null;
    
    // Notes configuration for a 3-octave piano (C3 to B5)
    const octaves = [3, 4, 5];
    const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
    const blackNotes = ['C#', 'D#', 'F#', 'G#', 'A#'];
    // Map white keys to their index in the full white key list
    let whiteKeyList = [];
    octaves.forEach(octave => {
      whiteNotes.forEach(note => {
        whiteKeyList.push(note + octave);
      });
    });

    // Map for black key placement: after which white key does each black key appear
    const blackKeyOffsets = {
      'C#': 0,
      'D#': 1,
      'F#': 3,
      'G#': 4,
      'A#': 5
    };
    
    function createPianoKeyboard() {
      const pianoElement = document.getElementById('piano-keyboard');
      pianoElement.innerHTML = '';
      let whiteKeyElements = [];
      let keyIndex = 0;
      // 1. Render all white keys
      octaves.forEach(octave => {
        whiteNotes.forEach((note, i) => {
          const whiteKey = document.createElement('div');
          whiteKey.className = 'white-key';
          whiteKey.setAttribute('data-note', `${note}${octave}`);
          whiteKey.style.position = 'relative';
          whiteKey.style.display = 'inline-flex';
          whiteKey.style.verticalAlign = 'bottom';

          const keyLabel = document.createElement('div');
          keyLabel.className = 'key-label';
          keyLabel.textContent = `${note}${octave}`;
          whiteKey.appendChild(keyLabel);

          whiteKey.addEventListener('click', function() {
            const noteName = this.getAttribute('data-note');
            playAndAddToSequence(noteName);
            this.classList.add('active');
            setTimeout(() => this.classList.remove('active'), 300);
          });

          pianoElement.appendChild(whiteKey);
          whiteKeyElements.push(whiteKey);
          keyIndex++;
        });
      });
      // 2. Overlay all black keys at correct positions
      let totalWhiteKeys = whiteKeyElements.length;
      let globalWhiteIndex = 0;
      octaves.forEach(octave => {
        whiteNotes.forEach((note, i) => {
          // For each white key, check if a black key should be placed after it
          if (i < whiteNotes.length - 1) { // No black key after B
            let blackNoteName = null;
            if (note === 'C' || note === 'D' || note === 'F' || note === 'G' || note === 'A') {
              // Map to black note
              if (note === 'C') blackNoteName = `C#${octave}`;
              if (note === 'D') blackNoteName = `D#${octave}`;
              if (note === 'F') blackNoteName = `F#${octave}`;
              if (note === 'G') blackNoteName = `G#${octave}`;
              if (note === 'A') blackNoteName = `A#${octave}`;
            }
            if (blackNoteName) {
              const blackKey = document.createElement('div');
              blackKey.className = 'black-key';
              blackKey.setAttribute('data-note', blackNoteName);
              // Position black key between this white key and the next
              blackKey.style.position = 'absolute';
              blackKey.style.left = `${(globalWhiteIndex + 1) * 38 - 11}px`;
              blackKey.style.top = '0';
              const blackKeyLabel = document.createElement('div');
              blackKeyLabel.className = 'key-label';
              blackKeyLabel.textContent = blackNoteName;
              blackKey.appendChild(blackKeyLabel);
              blackKey.addEventListener('click', function() {
                const noteName = this.getAttribute('data-note');
                playAndAddToSequence(noteName);
                this.classList.add('active');
                setTimeout(() => this.classList.remove('active'), 300);
              });
              pianoElement.appendChild(blackKey);
            }
          }
          globalWhiteIndex++;
        });
      });
      // 3. Add octave labels
      let octaveStart = 0;
      octaves.forEach((octave, idx) => {
        const octaveLabel = document.createElement('div');
        octaveLabel.className = 'octave-label';
        octaveLabel.textContent = `Octave ${octave}`;
        octaveLabel.style.left = `${(octaveStart + 3.5) * 38}px`;
        pianoElement.appendChild(octaveLabel);
        octaveStart += 7;
      });
    }
    
    function playAndAddToSequence(note) {
      // Play the note immediately
      Tone.start();
      synth.triggerAttackRelease(note, "8n");
      
      // Add to the sequence
      noteSequence.push(note);
      updateSequenceDisplay();
      
      // If sequence is playing, update it
      if (Tone.Transport.state === "started") {
        updateSequencePlayer();
      }
    }
    
    function updateSequenceDisplay() {
      const display = document.getElementById("sequence-display");
      const emptyMessage = document.getElementById("empty-message");
      
      if (noteSequence.length > 0) {
        if (emptyMessage) emptyMessage.remove();
        
        display.innerHTML = "";
        noteSequence.forEach((note, index) => {
          const pill = document.createElement("span");
          pill.className = "note-pill";
          pill.textContent = note;
          display.appendChild(pill);
        });
      } else {
        display.innerHTML = "<p id='empty-message'>Click piano keys to add notes to the sequence</p>";
      }
    }
    
    function updateSequencePlayer() {
      if (sequencePlayer) {
        sequencePlayer.dispose();
      }
      if (noteSequence.length > 0) {
        // Calculate duration based on number of notes, minimum of one bar
        const barDuration = Math.max(1, Math.ceil(noteSequence.length / 4));
        console.log("Creating sequence with notes:", noteSequence, "barDuration:", barDuration);
        sequencePlayer = new Tone.Sequence((time, note) => {
          console.log("Playing note:", note, "at time:", time);
          synth.triggerAttackRelease(note, "8n", time);
          // Highlight the key that's playing
          const key = document.querySelector(`[data-note="${note}"]`);
          if (key) {
            key.classList.add('active');
            setTimeout(() => key.classList.remove('active'), 150);
          }
        }, noteSequence, "4n");
        // Set loop duration in bars
        Tone.Transport.timeSignature = 4;
        sequencePlayer.loop = true;
        sequencePlayer.loopEnd = barDuration + "m";
        sequencePlayer.start(0);
        console.log("Sequence started, loopEnd:", sequencePlayer.loopEnd);
      }
    }
    
    async function startSequence() {
      if (Tone.context.state !== "running") {
        await Tone.context.resume();
        console.log("Resumed Tone.context, state:", Tone.context.state);
      }
      console.log("startSequence called");
      if (noteSequence.length === 0) {
        alert("Add some notes to the sequence first!");
        return;
      }
      if (sequencePlayer) {
        sequencePlayer.stop();
        sequencePlayer.dispose();
        sequencePlayer = null;
      }
      await Tone.Transport.stop();
      Tone.Transport.position = 0;
      Tone.Transport.cancel(0); // Clear all scheduled events
      updateSequencePlayer();
      console.log("After updateSequencePlayer, sequencePlayer:", sequencePlayer);
      Tone.Transport.start();
      console.log("Tone.Transport state:", Tone.Transport.state);
    }
    
    function stopSequence() {
      Tone.Transport.stop();
      Tone.Transport.position = 0;
      if (sequencePlayer) {
        sequencePlayer.stop();
      }
    }
    
    function clearSequence() {
      stopSequence();
      noteSequence = [];
      updateSequenceDisplay();
    }
    
    // Initialize piano keyboard when page loads
    window.onload = function() {
      createPianoKeyboard();
    };
  </script>
</body>
</html>
